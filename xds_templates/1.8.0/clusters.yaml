version_info: '{{ version|default(0) }}'
resources:
{% for instance in instances %}
{% for cluster in instance.parameters.clusters %}
  {% set service_name = instance.get('alt_service_name', instance.instance_id) %}
  {% set endpoints = eds.locality_lb_endpoints(cluster.hosts, discovery_request, resolve_dns=False) %}
  - '@type': type.googleapis.com/envoy.api.v2.Cluster
    name: {{ service_name }}-{{ cluster.name }}
    connect_timeout: 5s
    per_connection_buffer_limit_bytes: 16777216
    common_http_protocol_options:
      idle_timeout: 55s
    dns_lookup_family: V4_ONLY

    type: strict_dns
    load_assignment:
      cluster_name: {{ service_name }}-{{ cluster.name }}
      endpoints: {{ endpoints|tojson }}

    {% if utils.upstream_requires_tls(cluster) %}
    tls_context: {}
    {% endif %}

    {% if utils.healthchecks_enabled(cluster.healthchecks) %}
    common_lb_config:
      healthy_panic_threshold:
        value: 20
    health_checks:
    {% for healthcheck in cluster.healthchecks %}
      - interval: 15s
        no_traffic_interval: 45s
        timeout: 15s
        unhealthy_threshold: 3
        healthy_threshold: 1
        reuse_connection: yes
        http_health_check:
          path: {{ healthcheck.path }}
    {% endfor %}
    {% endif %}

{% endfor %}
{% endfor %}
