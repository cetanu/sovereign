---
test_name: Poll until server is ready

stages:
  - name: polling
    max_retries: 15
    delay_before: 2
    request:
      url: 'http://envoy:9901/listeners'
      method: GET
    response:
      body:
        - 0.0.0.0:80
        - 0.0.0.0:443

---
test_name: Admin interface - xDS data

stages:
  - name: Envoy Proxy has some cluster configuration
    request:
      url: 'http://envoy:9901/clusters'
      method: GET
    response:
      body:
        $ext:
          function: tavern.testutils.helpers:validate_regex
          extra_kwargs:
            expression: "google-proxy::added_via_api::true"

  - name: Envoy Proxy has some route configuration
    request:
      url: 'http://envoy:9901/config_dump'
      method: GET
    response:
      body:
        $ext:
          function: tavern.testutils.helpers:validate_regex
          extra_kwargs:
            expression: "google-proxy_virtualhost"
