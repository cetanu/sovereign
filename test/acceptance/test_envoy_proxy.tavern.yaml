---
test_name: Poll until server is ready

stages:
  - name: polling
    max_retries: 15
    delay_before: 2
    request:
      url: 'http://envoy:9901/listeners'
      method: GET
    response:
      body:
        - 0.0.0.0:80
        - 0.0.0.0:443

---
test_name: /clusters

stages:
  - name: Envoy Proxy has some cluster configuration
    request:
      url: 'http://envoy:9901/clusters'
      method: GET
    response:
      body:
        $ext:
          function: tavern.testutils.helpers:validate_regex
          extra_kwargs:
            expression: "httpbin-proxy::added_via_api::true"

---
test_name: /config_dump

stages:
  - name: Envoy Proxy has some route configuration
    request:
      url: 'http://envoy:9901/config_dump'
      method: GET
    response:
      body:
        $ext:
          function: tavern.testutils.helpers:validate_regex
          extra_kwargs:
            expression: "httpbin-proxy_virtualhost"

---
test_name: /certs

stages:
  - name: Envoy Proxy has the inline certificate from Secrets Discovery Service
    request:
      url: 'http://envoy:9901/certs'
      method: GET
    response:
      body:
        certificates:
          - ca_cert: []
            cert_chain: []
          - ca_cert: []
            cert_chain:
              - days_until_expiration: !anystr
                expiration_time: !anystr
                path: "<inline>"
                serial_number: !anystr
                subject_alt_names: []
                valid_from: !anystr

---
test_name: https://example.local/say_hello

stages:
  - name: Envoy Proxy has some route configuration
    request:
      url: 'https://envoy/say_hello'
      headers:
        Host: example.local
      method: GET
      verify: False
    response:
      body:
        message: Hello!
