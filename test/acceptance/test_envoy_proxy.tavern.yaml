---
test_name: Poll until server is ready

marks:
  - v1_12_0

stages:
  - name: polling
    max_retries: 15
    delay_before: 2
    request:
      url: 'http://envoy:9901/listeners?format=json'
      method: GET
    response:
      body:
        listener_statuses:
          - name: redirect_to_https
            local_address:
              socket_address:
                address: 0.0.0.0
                port_value: 80
          - name: https_listener
            local_address:
              socket_address:
                address: 0.0.0.0
                port_value: 443

---
test_name: Poll until server is ready

marks:
  - v1_9_0
  - v1_10_0
  - v1_11_0
  - v1_11_1
  - v1_11_2

stages:
  - name: polling
    max_retries: 15
    delay_before: 2
    request:
      url: 'http://envoy:9901/listeners'
      method: GET
    response:
      body:
        - 0.0.0.0:80
        - 0.0.0.0:443

---
test_name: /clusters

marks:
  - v1_9_0
  - v1_10_0
  - v1_11_0
  - v1_11_1
  - v1_11_2
  - v1_12_0

stages:
  - name: Envoy Proxy has some cluster configuration
    request:
      url: 'http://envoy:9901/clusters'
      method: GET
    response:
      body:
        $ext:
          function: tavern.testutils.helpers:validate_regex
          extra_kwargs:
            expression: "httpbin-proxy::added_via_api::true"

---
test_name: /config_dump

marks:
  - v1_9_0
  - v1_10_0
  - v1_11_0
  - v1_11_1
  - v1_11_2
  - v1_12_0

stages:
  - name: Envoy Proxy has some route configuration
    request:
      url: 'http://envoy:9901/config_dump'
      method: GET
    response:
      body:
        $ext:
          function: tavern.testutils.helpers:validate_regex
          extra_kwargs:
            expression: "httpbin-proxy_virtualhost"

---
test_name: /certs

marks:
  - v1_9_0
  - v1_10_0
  - v1_11_0
  - v1_11_1
  - v1_11_2
  - v1_12_0

stages:
  - name: Envoy Proxy has the inline certificate from Secrets Discovery Service
    request:
      url: 'http://envoy:9901/certs'
      method: GET
    response:
      body:
        certificates:
          - ca_cert: []
            cert_chain: []
          - ca_cert: []
            cert_chain:
              - days_until_expiration: !anystr
                expiration_time: !anystr
                path: "<inline>"
                serial_number: !anystr
                subject_alt_names: []
                valid_from: !anystr

---
test_name: https://example.local/say_hello

marks:
  - v1_9_0
  - v1_10_0
  - v1_11_0
  - v1_11_1
  - v1_11_2
  - v1_12_0

stages:
  - name: Envoy Proxy has some route configuration
    request:
      url: 'https://envoy/say_hello'
      headers:
        Host: example.local
      method: GET
      verify: False
    response:
      body:
        message: Hello!
