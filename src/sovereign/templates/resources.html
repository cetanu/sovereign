{%- extends 'base.html' %}
{% block title %}{{ resource_type|capitalize }}{% endblock %}

{% block head %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script>
      // Only store resource metadata (names/identifiers), not full content
      const resourceNames = [
        {% for resource in resources %}
          "{{ resource.name or resource.cluster_name or 'Unknown' }}"{% if not loop.last %},{% endif %}
        {% endfor %}
      ];
      const resources = resourceNames.map((name, index) => ({ name: name, index: index }));
      let filteredResources = [...resources];
    </script>
    <style>
        #filterInput {
            font-family: monospace;
        }
        .filtered {
            display: none;
        }
        .tooltip {
          position: relative;
          display: inline-block;
          cursor: help;
        }
        .tooltip .tooltip-text {
          visibility: hidden;
          width: 220px;
          background-color: #363636;
          color: #fff;
          text-align: left;
          padding: 0.5rem;
          border-radius: 6px;
          position: absolute;
          z-index: 1;
          top: 125%;
          left: 50%;
          margin-left: -110px;
          opacity: 0;
          transition: opacity 0.3s;
          font-size: 0.875rem;
        }
        .tooltip:hover .tooltip-text {
          visibility: visible;
          opacity: 1;
        }
        
        /* Side panel styles */
        .side-panel {
          position: fixed;
          top: 0;
          right: -100%;
          width: 90%;
          max-width: 800px;
          min-width: 400px;
          height: 100vh;
          background-color: #363636;
          color: white;
          z-index: 1000;
          transition: right 0.3s ease-in-out;
          overflow-y: auto;
          box-shadow: -2px 0 5px rgba(0,0,0,0.3);
        }
        
        .side-panel.is-active {
          right: 0;
        }
        
        /* Responsive side panel sizing */
        @media (min-width: 768px) {
          .side-panel {
            width: 60%;
            right: -60%;
          }
        }
        
        @media (min-width: 1024px) {
          .side-panel {
            width: 50%;
            right: -50%;
          }
        }
        
        @media (min-width: 1400px) {
          .side-panel {
            width: 40%;
            right: -40%;
          }
        }
        
        /* Ensure panel doesn't exceed viewport on very small screens */
        @media (max-width: 480px) {
          .side-panel {
            width: 95%;
            min-width: 300px;
            right: -95%;
          }
        }
        
        .side-panel-header {
          padding: 1rem;
          background-color: #433fca;
          border-bottom: 1px solid #555;
          position: sticky;
          top: 0;
          z-index: 1001;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        
        /* Responsive header */
        @media (max-width: 480px) {
          .side-panel-header {
            padding: 0.75rem;
          }
          
          .side-panel-header h4 {
            font-size: 1rem !important;
          }
        }
        
        .side-panel-content {
          padding: 0;
        }
        
        .json-container {
          position: relative;
        }
        
        .json-header {
          padding: 1rem;
          border-bottom: 1px solid #555;
          background-color: #2d2d2d;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        
        .copy-button {
          background-color: #433fca;
          border: none;
          color: white;
          padding: 0.5rem 1rem;
          border-radius: 4px;
          cursor: pointer;
          font-size: 0.875rem;
          transition: background-color 0.2s;
        }
        
        .copy-button:hover {
          background-color: #3834bc;
        }
        
        .copy-button:active {
          background-color: #2f2a9e;
        }
        
        .side-panel-close {
          background: none;
          border: none;
          color: white;
          font-size: 1.5rem;
          cursor: pointer;
          float: right;
          padding: 0;
          margin: 0;
        }
        
        .side-panel-close:hover {
          color: #ccc;
        }
        
        .json-content {
          background-color: #1e1e1e;
          border: none;
          border-radius: 0;
          padding: 1rem;
          font-family: 'JetBrains Mono', 'Fira Code', 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Source Code Pro', 'Menlo', 'Consolas', monospace;
          font-size: 0.875rem;
          line-height: 1.5;
          white-space: pre-wrap;
          word-wrap: break-word;
          max-height: calc(100vh - 250px);
          overflow-y: auto;
          color: #d4d4d4;
          margin: 0;
        }
        
        /* JSON Syntax Highlighting - VS Code Dark+ theme colors */
        .json-key {
          color: #9cdcfe;
          font-weight: 400;
        }
        
        .json-string {
          color: #ce9178;
        }
        
        .json-number {
          color: #b5cea8;
        }
        
        .json-boolean {
          color: #569cd6;
          font-weight: 500;
        }
        
        .json-null {
          color: #569cd6;
          font-weight: 500;
          font-style: italic;
        }
        
        .json-punctuation {
          color: #d4d4d4;
        }
        
        /* Improve readability */
        .json-content::-webkit-scrollbar {
          width: 8px;
        }
        
        .json-content::-webkit-scrollbar-track {
          background: #2d2d2d;
        }
        
        .json-content::-webkit-scrollbar-thumb {
          background: #555;
          border-radius: 4px;
        }
        
        .json-content::-webkit-scrollbar-thumb:hover {
          background: #666;
        }
        
        /* Collapsible JSON */
        .json-toggle {
          cursor: pointer;
          user-select: none;
          color: #808080;
          margin-right: 0.25rem;
          font-family: monospace;
          font-size: 0.875rem;
        }
        
        .json-toggle:hover {
          color: #fff;
        }
        
        .json-collapsible {
          margin-left: 1rem;
        }
        
        .json-collapsed {
          display: none;
        }
        
        .loading-spinner {
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid #f3f3f3;
          border-top: 3px solid #433fca;
          border-radius: 50%;
          animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        
        /* Prevent body scroll when side panel is open */
        body.side-panel-open {
          overflow: hidden;
        }
        
        /* Backdrop overlay for side panel */
        .side-panel-backdrop {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          z-index: 999;
          opacity: 0;
          visibility: hidden;
          transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        
        .side-panel-backdrop.is-active {
          opacity: 1;
          visibility: visible;
        }
        
        /* Show backdrop on smaller screens */
        @media (max-width: 1024px) {
          .side-panel-backdrop.is-active {
            opacity: 1;
            visibility: visible;
          }
        }
        
        /* Chunked JSON loading styles */
        .json-chunk-controls {
          padding: 1rem;
          background-color: #2d2d2d;
          border-bottom: 1px solid #555;
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex-wrap: wrap;
          gap: 0.5rem;
        }
        
        .chunk-info {
          color: #d4d4d4;
          font-size: 0.875rem;
          min-width: 200px;
        }
        
        .chunk-controls {
          display: flex;
          gap: 0.5rem;
          align-items: center;
          flex-wrap: wrap;
        }
        
        /* Responsive chunk controls */
        @media (max-width: 600px) {
          .json-chunk-controls {
            flex-direction: column;
            align-items: stretch;
            padding: 0.75rem;
          }
          
          .chunk-info {
            text-align: center;
            min-width: auto;
            margin-bottom: 0.5rem;
          }
          
          .chunk-controls {
            justify-content: center;
          }
          
          .chunk-button {
            flex: 1;
            min-width: 70px;
            font-size: 0.75rem;
            padding: 0.4rem 0.6rem;
          }
        }
        
        .chunk-button {
          background-color: #433fca;
          border: none;
          color: white;
          padding: 0.25rem 0.75rem;
          border-radius: 4px;
          cursor: pointer;
          font-size: 0.75rem;
          transition: background-color 0.2s;
        }
        
        .chunk-button:hover {
          background-color: #3834bc;
        }
        
        .chunk-button:disabled {
          background-color: #555;
          cursor: not-allowed;
        }
        
        .chunk-size-selector {
          background-color: #1e1e1e;
          border: 1px solid #555;
          color: white;
          padding: 0.25rem 0.5rem;
          border-radius: 4px;
          font-size: 0.75rem;
        }
        
        .json-size-warning {
          background-color: #ffdd57;
          color: #000;
          padding: 0.75rem;
          margin: 0;
          font-size: 0.875rem;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        
        .warning-actions {
          display: flex;
          gap: 0.5rem;
        }
        
        .warning-button {
          background-color: #000;
          color: #ffdd57;
          border: 1px solid #000;
          padding: 0.25rem 0.75rem;
          border-radius: 4px;
          cursor: pointer;
          font-size: 0.75rem;
        }
        
        .warning-button:hover {
          background-color: #333;
        }
    </style>

{% endblock %}


{%- block body %}
    <div class="content">
        <p class="content">
        <div class="columns">
            <div class="column is-narrow">
                <div class="dropdown is-hoverable">
                    <div class="dropdown-trigger">
                        <button class="button is-dark" aria-haspopup="true" aria-controls="dropdown-menu">
                            <span>Template Version</span>
                            <span class="icon is-small">
                                <i class="fas fa-angle-down" aria-hidden="false"></i>
                            </span>
                        </button>
                    </div>
                    <div class="dropdown-menu" id="dropdown-menu" role="menu">
                        <div class="dropdown-content">
                            <div class="dropdown-item">
                                <p>All resources will be formatted for the selected version</p>
                            </div>
                            {% for v in available_versions %}
                                <a class="dropdown-item{% if v == version %} is-active{% endif %}"
                                   href="/ui/set-version?version={{ v }}">
                                    {{ v.replace('_', '') }}
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <!-- node expression box --> 
            <div class="column">
                <form id="filterForm">
                    <input id="filterInput" class="input is-dark" type="text" placeholder="Node filter expression"/>
                </form>
            </div>
            <div class="column is-narrow">
                <div class="tooltip">
                  <span class="button is-primary">?</span>
                  <div class="tooltip-text">
                      <p>Space-delimited Node filter.<p>
                      Examples:<br>
                      <code>id=envoy-1234</code><br>
                      <code>cluster=a_service_cluster</code><br>
                      <code>locality.zone=us-east-1</code><br>
                      <code>locality.sub_zone=a</code><br>
                      <code>metadata.field_name=abcdef</code>
                  </div>
                </div>
            </div>
            </p>
        </div>
    </div>

    {% set count = resources|length %}
    {% if count > 0 %}
    <nav class="panel is-dark" id="resources">
        <p class="panel-heading">
            {{ resource_type|capitalize }}
        </p>
        <div class="panel-block">
            <p class="control has-icons-left">
                <label for="search_filter">
                    <input
                            class="input"
                            type="text"
                            id="search_filter"
                            onkeyup="filter_results('search_filter')"
                            placeholder="Filter {{ resource_type }} by any string"
                    >
                </label>
                <span class="icon is-left">
                <i class="fas fa-search" aria-hidden="true"></i>
            </span>
            </p>
        </div>

        {% set res = resources|selectattr('get')|list %}
        {% set plural = {
            0: 'resources',
            1: 'resource'
        } %}
        {# begin pagination #}
        <div id="resource-container">
            {# Will be filled in #}
        </div>
        {# pagination control bar #}
        <div class="panel-block">
            <p class="content is-small" id="resource-count">
                {{ count }} {{ plural.get(count, 'resources') }}
            </p>
        </div>
    </nav>
        <nav class="pagination is-right is-small" role="navigation" aria-label="pagination">
          <a id="prev-btn" class="pagination-previous">Previous</a>
          <a id="next-btn" class="pagination-next">Next</a>
          <ul id="page-numbers" class="pagination-list"></ul>
        </nav>

        {% if resource_type == 'routes' %}
            <nav class="panel">
              <p class="panel-heading">Virtual Hosts</p>
              <div class="panel-block">
                <p class="control has-icons-left">
                  <input id="searchInput" class="input" type="text" placeholder="Filter virtual-hosts by any string" />
                  <span class="icon is-left">
                    <i class="fas fa-search" aria-hidden="true"></i>
                  </span>
                </p>
              </div>
              <p class="panel-tabs">
                <a class="is-active" onclick="filterTabs(this, 'all')">All</a>
                {% for resource in res %}
                    <a onclick="filterTabs(this, '{{ resource["name"] }}')">
                        {{ resource['name'] }}
                    </a>
                {% endfor %}
              </p>
              {% for resource in res %}
                  {% if resource["virtual_hosts"] %}
                  {% for virtualhost in resource['virtual_hosts'] %}
                      <a class="panel-block virtualhost"
                         data-category="{{ resource['name'] }}"
                         href="#"
                         onclick="loadVirtualHostInSidePanel('{{ resource['name'] }}', '{{ virtualhost['name'] }}'); return false;">
                      <span class="panel-icon">
                          <i class="fas fa-arrow-right" aria-hidden="true"></i>
                      </span>
                          {{ virtualhost['name'] }}
                      </a>
                  {% endfor %}
                  {% else %}
                    <span class="panel-icon">
                        <i class="fas fa-arrow-right" aria-hidden="true"></i>
                    </span>
                    <div class="notification is-danger">
                        No resources found
                        <script>
                          setTimeout(() => location.reload(), 2000);
                        </script>
                    </div>
                  {% endif %}
              {% endfor %}
            </nav>
        {% endif %}
    {% else %}
        <span class="panel-icon">
            <i class="fas fa-arrow-right" aria-hidden="true"></i>
        </span>
        <div class="notification is-danger">
            No resources found
            <script>
              setTimeout(() => location.reload(), 2000);
            </script>
        </div>
    {% endif %}
    {% if show_debuginfo %}
    <pre>
    {%- if discovery_request != None %}
    ---
    DiscoveryRequest:
      Node:
        Id: {{ discovery_request.node.id }}
        Cluster: {{ discovery_request.node.cluster }}
        Metadata: {{ discovery_request.node.metadata }}
        Locality: {{ discovery_request.node.locality }}
        Build Version: {{ discovery_request.node.build_version }}
      Version Info: {{ discovery_request.version_info }}
      Resource Names: {{ discovery_request.resources or "*" }}
      # Sovereign-generated fields
      Envoy Version: {{ discovery_request.envoy_version }}
      Host Header: {{ discovery_request.desired_controlplane }}
    {%- endif %}
    {%- if discovery_response != None %}
    ---
    DiscoveryResponse:
      Config version: {{ discovery_response.version }}
    {%- endif %}
    </pre>
    {% endif %}
    
    <!-- Side Panel Backdrop -->
    <div id="sidePanelBackdrop" class="side-panel-backdrop"></div>
    
    <!-- Side Panel -->
    <div id="sidePanel" class="side-panel">
        <div class="side-panel-header">
            <h4 class="title is-4" style="color: white; margin: 0;">
                <span id="sidePanelTitle">Resource Details</span>
            </h4>
            <button class="side-panel-close" onclick="closeSidePanel()">&times;</button>
        </div>
        <div class="side-panel-content">
            <div id="sidePanelContent">
                <p>Select a resource to view its details.</p>
            </div>
        </div>
    </div>
{% endblock -%}
{% block footer %}
<div class="content has-text-centered is-small">
    <script src="/static/node_expression.js"></script>
    <script src="/static/panel.js"></script>
    <script>
    // Side panel functionality
    function openSidePanel() {
        document.getElementById('sidePanel').classList.add('is-active');
        document.getElementById('sidePanelBackdrop').classList.add('is-active');
        document.body.classList.add('side-panel-open');
    }
    
    function closeSidePanel() {
        document.getElementById('sidePanel').classList.remove('is-active');
        document.getElementById('sidePanelBackdrop').classList.remove('is-active');
        document.body.classList.remove('side-panel-open');
    }
    
    function showLoading() {
        document.getElementById('sidePanelContent').innerHTML = `
            <div style="text-align: center; padding: 2rem;">
                <div class="loading-spinner"></div>
                <p style="margin-top: 1rem;">Loading resource data...</p>
            </div>
        `;
    }
    
    function showError(message) {
        document.getElementById('sidePanelContent').innerHTML = `
            <div class="notification is-danger">
                <strong>Error:</strong> ${message}
            </div>
        `;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function syntaxHighlight(json) {
        if (typeof json !== 'string') {
            json = JSON.stringify(json, null, 2);
        }
        
        // Escape HTML first
        json = escapeHtml(json);
        
        // Apply syntax highlighting
        json = json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
            let cls = 'json-number';
            if (/^"/.test(match)) {
                if (/:$/.test(match)) {
                    cls = 'json-key';
                    // Remove the colon from the match for styling, we'll add it back
                    match = match.slice(0, -1);
                    return '<span class="' + cls + '">' + match + '</span><span class="json-punctuation">:</span>';
                } else {
                    cls = 'json-string';
                }
            } else if (/true|false/.test(match)) {
                cls = 'json-boolean';
            } else if (/null/.test(match)) {
                cls = 'json-null';
            }
            return '<span class="' + cls + '">' + match + '</span>';
        });
        
        // Highlight punctuation (brackets, braces, commas)
        json = json.replace(/([{}[\],])/g, '<span class="json-punctuation">$1</span>');
        
        return json;
    }
    
    function makeJsonCollapsible(element) {
        // This function would add collapsible functionality
        // For now, we'll keep it simple and just return the element
        // Future enhancement: add click handlers for { } and [ ] to collapse/expand
        return element;
    }
    
    function copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
            // Use the modern clipboard API
            navigator.clipboard.writeText(text).then(() => {
                showCopySuccess();
            }).catch(err => {
                console.error('Failed to copy: ', err);
                fallbackCopyTextToClipboard(text);
            });
        } else {
            // Fallback for older browsers
            fallbackCopyTextToClipboard(text);
        }
    }
    
    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showCopySuccess();
            }
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
        }
        
        document.body.removeChild(textArea);
    }
    
    function showCopySuccess() {
        const copyBtn = document.querySelector('.copy-button');
        if (copyBtn) {
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'Copied!';
            copyBtn.style.backgroundColor = '#48c774';
            setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.style.backgroundColor = '#433fca';
            }, 2000);
        }
    }
    
    // Global variables for chunked loading
    let currentResourceData = null;
    let currentChunkSize = 1000; // lines
    let currentChunkIndex = 0;
    let totalChunks = 0;
    
    async function loadResourceInSidePanel(resourceType, resourceName) {
        document.getElementById('sidePanelTitle').textContent = `${resourceType}: ${resourceName}`;
        openSidePanel();
        showLoading();
        
        try {
            // Get current URL parameters to maintain context
            const urlParams = new URLSearchParams(window.location.search);
            const region = urlParams.get('region') || '';
            const apiVersion = urlParams.get('api_version') || 'v2';
            
            // Build the fetch URL with current parameters
            let fetchUrl = `/ui/resources/${resourceType}/${encodeURIComponent(resourceName)}`;
            const params = new URLSearchParams();
            if (region) params.append('region', region);
            params.append('api_version', apiVersion);
            
            if (params.toString()) {
                fetchUrl += '?' + params.toString();
            }
            
            const response = await fetch(fetchUrl, {
                credentials: 'same-origin' // Include cookies in the request
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            const jsonString = JSON.stringify(data, null, 2);
            const sizeKB = (new Blob([jsonString]).size / 1024).toFixed(1);
            const sizeMB = sizeKB / 1024;
            
            // Store the data globally
            currentResourceData = {
                data: data,
                jsonString: jsonString,
                sizeKB: sizeKB,
                sizeMB: sizeMB
            };
            
            // Check if the JSON is large and show warning/chunked view
            // Use a lower threshold (500KB) to be more conservative about browser performance
            const threshold = localStorage.getItem('jsonSizeThreshold') || 0.5; // MB
            if (sizeMB > threshold) {
                // Check user preference for auto-chunking
                const autoChunk = localStorage.getItem('autoChunkLargeJson') === 'true';
                if (autoChunk) {
                    showChunkedJson();
                } else {
                    showLargeJsonWarning(resourceType, resourceName);
                }
            } else {
                showFullJson();
            }
        } catch (error) {
            console.error('Error loading resource:', error);
            showError(error.message);
        }
    }
    
    function showLargeJsonWarning(resourceType, resourceName) {
        const sizeKB = currentResourceData.sizeKB;
        const sizeMB = currentResourceData.sizeMB;
        
        document.getElementById('sidePanelContent').innerHTML = `
            <div class="json-size-warning">
                <div>
                    <strong>‚ö†Ô∏è Large JSON detected (${sizeKB} KB / ${sizeMB.toFixed(1)} MB)</strong><br>
                    Loading this much data may slow down your browser. Choose an option:
                </div>
                <div class="warning-actions">
                    <button class="warning-button" onclick="event.stopPropagation(); showChunkedJson()">
                        View in Chunks
                    </button>
                    <button class="warning-button" onclick="event.stopPropagation(); showFullJson()">
                        Load Full JSON
                    </button>
                </div>
            </div>
            <div style="padding: 1rem; color: #d4d4d4;">
                <hr style="margin: 1rem 0; border-color: #555;">
                <div style="font-size: 0.875rem;">
                    <label style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                        <input type="checkbox" id="autoChunkPreference" style="margin-right: 0.5rem;">
                        Always use chunked view for large files (saves this preference)
                    </label>
                    <label style="display: flex; align-items: center;">
                        Size threshold: 
                        <select id="thresholdSelector" style="margin-left: 0.5rem; background: #1e1e1e; color: white; border: 1px solid #555; padding: 0.25rem;">
                            <option value="0.25">250 KB</option>
                            <option value="0.5" selected>500 KB</option>
                            <option value="1">1 MB</option>
                            <option value="2">2 MB</option>
                            <option value="5">5 MB</option>
                        </select>
                    </label>
                    <button class="warning-button" onclick="event.stopPropagation(); savePreferences()" style="margin-top: 0.5rem;">
                        Save Preferences
                    </button>
                </div>
            </div>
        `;
        
        // Set current values
        const currentThreshold = localStorage.getItem('jsonSizeThreshold') || 0.5;
        document.getElementById('thresholdSelector').value = currentThreshold;
        document.getElementById('autoChunkPreference').checked = localStorage.getItem('autoChunkLargeJson') === 'true';
    }
    
    function showChunkedJson() {
        const lines = currentResourceData.jsonString.split('\n');
        totalChunks = Math.ceil(lines.length / currentChunkSize);
        currentChunkIndex = 0;
        
        renderChunkedJson();
    }
    
    function showFullJson() {
        // Store the JSON string globally for copying
        window.currentJsonData = currentResourceData.jsonString;
        
        document.getElementById('sidePanelContent').innerHTML = `
            <div class="json-container">
                <div class="json-header">
                    <span style="color: #d4d4d4; font-size: 0.875rem;">JSON Response (${currentResourceData.sizeKB} KB)</span>
                    <button class="copy-button" onclick="event.stopPropagation(); copyToClipboard(window.currentJsonData)">
                        Copy JSON
                    </button>
                </div>
                <div class="json-content">${syntaxHighlight(currentResourceData.data)}</div>
            </div>
        `;
    }
    
    function renderChunkedJson() {
        const lines = currentResourceData.jsonString.split('\n');
        const startLine = currentChunkIndex * currentChunkSize;
        const endLine = Math.min(startLine + currentChunkSize, lines.length);
        const chunkLines = lines.slice(startLine, endLine);
        const chunkText = chunkLines.join('\n');
        
        // Store current chunk for copying
        window.currentJsonData = currentResourceData.jsonString; // Always allow copying full JSON
        window.currentChunkData = chunkText;
        
        document.getElementById('sidePanelContent').innerHTML = `
            <div class="json-container">
                <div class="json-header">
                    <span style="color: #d4d4d4; font-size: 0.875rem;">JSON Response (${currentResourceData.sizeKB} KB) - Chunked View</span>
                    <button class="copy-button" onclick="event.stopPropagation(); copyToClipboard(window.currentJsonData)">
                        Copy Full JSON
                    </button>
                </div>
                <div class="json-chunk-controls">
                    <div class="chunk-info">
                        Showing lines ${startLine + 1}-${endLine} of ${lines.length} 
                        (Chunk ${currentChunkIndex + 1} of ${totalChunks})
                    </div>
                    <div class="chunk-controls">
                        <label style="color: #d4d4d4; font-size: 0.75rem;">
                            Lines per chunk:
                            <select class="chunk-size-selector" onchange="event.stopPropagation(); changeChunkSize(this.value)">
                                <option value="500" ${currentChunkSize === 500 ? 'selected' : ''}>500</option>
                                <option value="1000" ${currentChunkSize === 1000 ? 'selected' : ''}>1000</option>
                                <option value="2000" ${currentChunkSize === 2000 ? 'selected' : ''}>2000</option>
                                <option value="5000" ${currentChunkSize === 5000 ? 'selected' : ''}>5000</option>
                            </select>
                        </label>
                        <button class="chunk-button" onclick="event.stopPropagation(); previousChunk()" ${currentChunkIndex === 0 ? 'disabled' : ''}>
                            ‚Üê Previous
                        </button>
                        <button class="chunk-button" onclick="event.stopPropagation(); nextChunk()" ${currentChunkIndex >= totalChunks - 1 ? 'disabled' : ''}>
                            Next ‚Üí
                        </button>
                        <button class="chunk-button" onclick="event.stopPropagation(); copyToClipboard(window.currentChunkData)">
                            Copy Chunk
                        </button>
                    </div>
                </div>
                <div style="padding: 0.5rem 1rem; background-color: #2d2d2d; border-bottom: 1px solid #555; font-size: 0.75rem; color: #999;">
                    üí° Tip: Use Ctrl+‚Üê and Ctrl+‚Üí to navigate between chunks
                </div>
                <div class="json-content">${syntaxHighlight(chunkText)}</div>
            </div>
        `;
    }
    
    function changeChunkSize(newSize) {
        currentChunkSize = parseInt(newSize);
        const lines = currentResourceData.jsonString.split('\n');
        totalChunks = Math.ceil(lines.length / currentChunkSize);
        
        // Adjust current chunk index to stay roughly in the same area
        const currentLine = currentChunkIndex * currentChunkSize;
        currentChunkIndex = Math.floor(currentLine / currentChunkSize);
        currentChunkIndex = Math.min(currentChunkIndex, totalChunks - 1);
        
        renderChunkedJson();
    }
    
    function previousChunk() {
        if (currentChunkIndex > 0) {
            currentChunkIndex--;
            renderChunkedJson();
        }
    }
    
    function nextChunk() {
        if (currentChunkIndex < totalChunks - 1) {
            currentChunkIndex++;
            renderChunkedJson();
        }
    }
    
    function savePreferences() {
        const autoChunk = document.getElementById('autoChunkPreference').checked;
        const threshold = document.getElementById('thresholdSelector').value;
        
        localStorage.setItem('autoChunkLargeJson', autoChunk);
        localStorage.setItem('jsonSizeThreshold', threshold);
        
        // Show confirmation
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'Saved!';
        button.style.backgroundColor = '#48c774';
        setTimeout(() => {
            button.textContent = originalText;
            button.style.backgroundColor = '#000';
        }, 2000);
    }
    
    async function loadVirtualHostInSidePanel(routeConfiguration, virtualHost) {
        document.getElementById('sidePanelTitle').textContent = `Virtual Host: ${virtualHost}`;
        openSidePanel();
        showLoading();
        
        try {
            // Get current URL parameters to maintain context
            const urlParams = new URLSearchParams(window.location.search);
            const region = urlParams.get('region') || '';
            const apiVersion = urlParams.get('api_version') || 'v2';
            
            // Build the fetch URL with current parameters
            let fetchUrl = `/ui/resources/routes/${encodeURIComponent(routeConfiguration)}/${encodeURIComponent(virtualHost)}`;
            const params = new URLSearchParams();
            if (region) params.append('region', region);
            params.append('api_version', apiVersion);
            
            if (params.toString()) {
                fetchUrl += '?' + params.toString();
            }
            
            const response = await fetch(fetchUrl, {
                credentials: 'same-origin' // Include cookies in the request
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            const jsonString = JSON.stringify(data, null, 2);
            const sizeKB = (new Blob([jsonString]).size / 1024).toFixed(1);
            const sizeMB = sizeKB / 1024;
            
            // Store the data globally
            currentResourceData = {
                data: data,
                jsonString: jsonString,
                sizeKB: sizeKB,
                sizeMB: sizeMB
            };
            
            // Check if the JSON is large and show warning/chunked view
            const threshold = localStorage.getItem('jsonSizeThreshold') || 0.5; // MB
            if (sizeMB > threshold) {
                // Check user preference for auto-chunking
                const autoChunk = localStorage.getItem('autoChunkLargeJson') === 'true';
                if (autoChunk) {
                    showChunkedJson();
                } else {
                    showLargeJsonWarning('Virtual Host', virtualHost);
                }
            } else {
                showFullJson();
            }
        } catch (error) {
            console.error('Error loading virtual host:', error);
            showError(error.message);
        }
    }
    
    // Close side panel when clicking outside of it
    document.addEventListener('click', function(event) {
        const sidePanel = document.getElementById('sidePanel');
        const backdrop = document.getElementById('sidePanelBackdrop');
        const isClickInsidePanel = sidePanel.contains(event.target);
        const isResourceLink = event.target.closest('.panel-block');
        const isBackdropClick = event.target === backdrop;
        
        if ((isBackdropClick || (!isClickInsidePanel && !isResourceLink)) && sidePanel.classList.contains('is-active')) {
            closeSidePanel();
        }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const sidePanel = document.getElementById('sidePanel');
            if (sidePanel.classList.contains('is-active')) {
                closeSidePanel();
            }
        }
        
        // Only handle chunk navigation if side panel is open and we're in chunked view
        if (document.getElementById('sidePanel').classList.contains('is-active') && 
            document.querySelector('.json-chunk-controls')) {
            
            if (event.key === 'ArrowLeft' && event.ctrlKey) {
                event.preventDefault();
                previousChunk();
            } else if (event.key === 'ArrowRight' && event.ctrlKey) {
                event.preventDefault();
                nextChunk();
            }
        }
    });
    
    const perPage = 10;
    let currentPage = 1;

    function filter_results(id) {
        const input = document.getElementById(id);
        const filter = input.value.toLowerCase();

        filteredResources = resources.filter((res) => {
            const name = res.name || "";
            return name.toLowerCase().includes(filter);
        });

        currentPage = 1;
        renderPage(currentPage);
        
        // Update the resource count display
        const countElement = document.getElementById('resource-count');
        if (countElement) {
            const count = filteredResources.length;
            const plural = count === 1 ? 'resource' : 'resources';
            countElement.textContent = `${count} ${plural}`;
        }
    }

    function renderPage(page) {
        const container = document.getElementById('resource-container');
        container.innerHTML = '';

        const start = (page - 1) * perPage;
        const end = start + perPage;
        const pageItems = filteredResources.slice(start, end);

        for (const resource of pageItems) {
          const name = resource.name;
          const item = document.createElement('a');
          item.className = 'panel-block has-text-weight-medium';
          item.href = '#';
          item.onclick = (e) => {
              e.preventDefault();
              loadResourceInSidePanel('{{ resource_type }}', name);
          };
          item.innerHTML = `
              <span class="panel-icon">
                  <i class="fas fa-arrow-right" aria-hidden="true"></i>
              </span>
              ${name}
          `;
          container.appendChild(item);
        }
        renderPaginationControls();
    }

    function renderPaginationControls() {
        const totalPages = Math.ceil(filteredResources.length / perPage);
        const pageList = document.getElementById('page-numbers');
        pageList.innerHTML = '';

        for (let i = 1; i <= totalPages; i++) {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.className = 'pagination-link';
          if (i === currentPage) a.classList.add('is-current');
          a.textContent = i;
          a.addEventListener('click', () => {
            currentPage = i;
            renderPage(currentPage);
          });
          li.appendChild(a);
          pageList.appendChild(li);
        }

        document.getElementById('prev-btn').disabled = currentPage === 1;
        document.getElementById('next-btn').disabled = currentPage === totalPages;
    }

    document.getElementById('prev-btn').addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderPage(currentPage);
    }
    });

    document.getElementById('next-btn').addEventListener('click', () => {
    const totalPages = Math.ceil(filteredResources.length / perPage);
    if (currentPage < totalPages) {
      currentPage++;
      renderPage(currentPage);
    }
    });
    renderPage(currentPage);
    </script>
</div>
{% endblock %}
