image: python:3.7

options:
  docker: true

pipelines:
  default:
    - step: &install
        name: Install deps & build containers
        caches: &caches
          - pip
          - docker
        script:
          - pip install --upgrade pip && pip install -r requirements-dev.txt
          - make build
    - parallel: &test
        - step:
            name: Run pylint
            caches: *caches
            script:
              - pip install --upgrade pip && pip install -r requirements-dev.txt
              - make lint
        - step:
            name: Unit tests
            caches: *caches
            script:
              - pip install --upgrade pip && pip install -r requirements-dev.txt
              - make unit
        - step:
            name: Acceptance tests
            caches: *caches
            script:
              - pip install --upgrade pip && pip install -r requirements-dev.txt
              - make run-daemon acceptance
  branches:
    master:
      - step: *install
      - parallel: *test
      - step:
          name: Release to PyPI
          script:
            - pip install --upgrade pip && pip install -r requirements-dev.txt
            - make release
