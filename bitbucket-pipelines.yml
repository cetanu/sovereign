image: python:3.12

definitions:
  services:
    docker:
      memory: 5120
  caches:
    docker-cliplugins: ~/.docker/cli-plugins
    uv:
      key:
        files:
          - uv.lock # if lockfile changes, invalidate cache
      path: ~/.cache/uv

  yaml-anchors:
    - &setup-docker-compose-latest-script >-
      wget --no-verbose --no-clobber https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 --output-document ~/.docker/cli-plugins/docker-compose
      || true
      ; chmod a+x ~/.docker/cli-plugins/docker-compose
      && ln --symbolic ~/.docker/cli-plugins/docker-compose /usr/local/bin/docker-compose

.set_environment: &set_environment |
  export UV_LINK_MODE=copy
  export UV_COMPILE_BYTECODE=1
  export UV_PYTHON=python3.12
  export UV_PROJECT_ENVIRONMENT="/opt/uv"
  export UV_KEYRING_PROVIDER=subprocess
  export PATH="/root/.local/bin:${PATH}"

.set_buildkit_false: &set_buildkit_false |
  export DOCKER_BUILDKIT=0

.install_uv: &install_uv |
  pip install pipx
  pipx install uv

options:
  # noinspection DockerUsage
  docker: true

pipelines:
  default:
    - parallel: &tests
        - step:
            name: Unit tests
            caches:
              - docker-cliplugins
              - uv
            script:
              - *set_environment
              - *set_buildkit_false
              - *setup-docker-compose-latest-script
              - *install_uv
              - make install-deps
              - make unit
        - step:
            name: Linting
            caches: [ uv ]
            script:
              - *set_environment
              - *install_uv
              - make install-deps
              - uv run ruff check src/sovereign
        - step:
            name: Format check
            caches: [ uv ]
            script:
              - *set_environment
              - *install_uv
              - make install-deps
              - uv run ruff format --check src/sovereign
        - step:
            name: Type checks
            caches: [ uv ]
            script:
              - *set_environment
              - *install_uv
              - make install-deps
              - uv run ty check src/sovereign
        - step:
            name: Acceptance test
            size: 2x
            # noinspection DockerUsage
            services:
              - docker
            caches:
              - docker-cliplugins
              - uv
            script:
              - *set_buildkit_false
              - *setup-docker-compose-latest-script
              - make test-envoy-version
            after-script:
              - docker compose ps
              - docker compose logs -t sovereign envoy mock aws
        - step:
            name: Acceptance test (worker v2)
            size: 2x
            # noinspection DockerUsage
            services:
              - docker
            caches:
              - docker-cliplugins
              - uv
            script:
              - *set_buildkit_false
              - *setup-docker-compose-latest-script
              - export SOVEREIGN_WORKER_V2_ENABLED=1
              - make test-envoy-version
            after-script:
              - docker compose ps
              - docker compose logs -t sovereign envoy mock aws
  branches:
    master:
      - parallel: *tests
      - step:
          name: Mirror to github
          script:
            - git remote add github git@github.com:cetanu/sovereign.git
            - git fetch --unshallow github
            - git branch --set-upstream-to master
            - git push --set-upstream --force github master
  tags:
    '*.*.*':
      - step:
          name: Release to PyPI
          deployment: release
          caches:
            - docker-cliplugins
            - uv
          script:
            - *set_environment
            - *set_buildkit_false
            - *setup-docker-compose-latest-script
            - *install_uv
            - make install-deps
            - make release
    '*.*.*rc*': &prerelease
      - step:
          name: Pre-release to PyPI
          deployment: prerelease
          caches:
            - docker-cliplugins
            - uv
          script:
            - *set_environment
            - *set_buildkit_false
            - *setup-docker-compose-latest-script
            - *install_uv
            - make install-deps
            - uv run python scripts/release_check.py
            - make release
    '*.*.*a*': *prerelease
    '*.*.*b*': *prerelease
