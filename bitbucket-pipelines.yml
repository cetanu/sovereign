image: python:3.7

options:
  docker: true

pipelines:
  default:
    - step:
        name: Build and test
        caches:
          - docker
          - pip
        script:
          - pip install --upgrade pip && pip install -r requirements-dev.txt
          - make lint
          - make unit
          - make run-daemon acceptance
  branches:
    master:
      - step:
          name: Install dependencies
          caches:
            - pip
          script:
            - pip install --upgrade pip && pip install -r requirements-dev.txt
      - step:
          name: Build containers
          caches:
            - pip
            - docker
          script:
            - pip install --upgrade pip && pip install -r requirements-dev.txt
            - make build
      - parallel:
          - step:
              name: Lint
              caches:
                - pip
              script:
                - pip install --upgrade pip && pip install -r requirements-dev.txt
                - make lint
          - step:
              name: Unit tests
              caches:
                - pip
                - docker
              script:
                - pip install --upgrade pip && pip install -r requirements-dev.txt
                - make unit
          - step:
              name: Acceptance tests
              caches:
                - pip
                - docker
              script:
                - pip install --upgrade pip && pip install -r requirements-dev.txt
                - make run-daemon acceptance
      - step:
          name: Release to PyPI
          script:
            - pip install --upgrade pip && pip install -r requirements-dev.txt
            - make release
