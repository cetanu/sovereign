image: python:3.7

options:
  docker: true

pipelines:
  default:
    - parallel: &test
        - step:
            name: Run pylint
            script:
              - pip install pylint
              - pip install --upgrade -r requirements.txt
              - make lint
        - step:
            name: Unit tests
            script:
              - >
                export CONFIG_LOADER_TEST='{"hello": "world"}';
                export SOVEREIGN_ENVIRONMENT_TYPE=local;
                export SOVEREIGN_CONFIG=file://test/config/config.yaml;
                export GIT_COMMIT_SHA=${BITBUCKET_COMMIT} && echo ${GIT_COMMIT_SHA};
                export GIT_BRANCH=${BITBUCKET_BRANCH} && echo ${GIT_BRANCH};
              - >
                curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter;
                chmod +x cc-test-reporter;
                ./cc-test-reporter before-build;
              - >
                python setup.py sdist;
                pip install --no-cache-dir --upgrade pip;
                pip install dist/sovereign-*.tar.gz;
                pip install --no-cache-dir --upgrade -r requirements-dev.txt;
              - pytest -vv --tb=short --ignore=test/acceptance --junitxml=test-reports/unit.xml --cov=./src/sovereign;
            after-script:
              - >
                coverage xml;
                ./cc-test-reporter after-build --debug --exit-code ${BITBUCKET_EXIT_CODE} --coverage-input-type coverage.py;
        - step:
            name: Acceptance tests
            script:
              - pip install --no-cache-dir --upgrade pip
              - pip install --no-cache-dir --upgrade -r requirements-dev.txt
              - pip install docker-compose
              - make run-daemon acceptance
            after-script:
              - docker logs controlplane
  branches:
    master:
      - parallel: *test
      - step:
          name: Release to PyPI
          script:
            - pip install docker-compose twine
            - make release
      - step:
          name: Documentation update
          script:
            - pip install docker-compose
            - git clone git@bitbucket.org:vsyrakis/vsyrakis.bitbucket.io.git
            - make html
            - rm -rf vsyrakis.bitbucket.io/sovereign/docs/*
            - cp -rvf src/sovereign/docs vsyrakis.bitbucket.io/sovereign
            - cd vsyrakis.bitbucket.io
            - git add -A
            - git status
            - git config user.email "vsyrakis@atlassian.com"
            - git config user.name "Vasilios Syrakis"
            - git commit -m "Documentation automatically updated by Sovereign pipeline"
            - git push
      - step:
          name: Mirror to github
          script:
            - git remote add --mirror=push github git@github.com:cetanu/sovereign.git
            - git push github
