image: python:3.7

.install_docker_compose: &install_docker_compose |
  pip install --no-cache-dir --upgrade pip
  pip install --no-cache-dir --upgrade -r requirements-dev.txt
  pip install docker-compose

options:
  docker: true

pipelines:
  default:
    - parallel: &unit
        - step:
            name: Run pylint
            script:
              - pip install pylint
              - pip install --upgrade -r requirements.txt
              - make lint
        - step:
            name: Unit tests
            script:
              - make before-build
              - make unit-local
            after-script:
              - make after-build
    - parallel: &acceptance
        - step:
            name: envoy-1.8.0
            script:
              - *install_docker_compose
              - IMAGE_TAG=v1.8.0 PYTEST_MARK=v1_8_0 make run-daemon acceptance
        - step:
            name: envoy-1.9.0
            script:
              - *install_docker_compose
              - IMAGE_TAG=v1.9.0 PYTEST_MARK=v1_9_0 make run-daemon acceptance
        - step:
            name: envoy-1.10.0
            script:
              - *install_docker_compose
              - IMAGE_TAG=v1.10.0 PYTEST_MARK=v1_10_0 make run-daemon acceptance
        - step:
            name: envoy-1.11.0
            script:
              - *install_docker_compose
              - IMAGE_TAG=v1.11.0 PYTEST_MARK=v1_11_0 make run-daemon acceptance
        - step:
            name: envoy-1.11.1
            script:
              - *install_docker_compose
              - IMAGE_TAG=v1.11.1 PYTEST_MARK=v1_11_1 make run-daemon acceptance
        - step:
            name: envoy-1.11.2
            script:
              - *install_docker_compose
              - IMAGE_TAG=v1.11.2 PYTEST_MARK=v1_11_2 make run-daemon acceptance
        - step:
            name: envoy-1.12.0
            script:
              - *install_docker_compose
              - IMAGE_TAG=v1.12.0 PYTEST_MARK=v1_12_0 make run-daemon acceptance
  branches:
    master:
      - parallel: *unit
      - step: *acceptance
      - step:
          name: Release to PyPI
          script:
            - pip install docker-compose twine
            - make release
      - step:
          name: Documentation update
          script:
            - pip install docker-compose
            - git clone git@bitbucket.org:vsyrakis/vsyrakis.bitbucket.io.git
            - make html
            - rm -rf vsyrakis.bitbucket.io/sovereign/docs/*
            - cp -rvf src/sovereign/docs vsyrakis.bitbucket.io/sovereign
            - cd vsyrakis.bitbucket.io
            - git add -A
            - git status
            - git config user.email "vsyrakis@atlassian.com"
            - git config user.name "Vasilios Syrakis"
            - git commit -m "Documentation automatically updated by Sovereign pipeline"
            - git push
      - step:
          name: Mirror to github
          script:
            - git remote add github git@github.com:cetanu/sovereign.git
            # Mirror master to master
            - git branch --set-upstream-to master
            - git push --set-upstream github master
            # Mirror a snapshot of the master branch to a branch for the current version
            - git branch --set-upstream-to v$(cat VERSION | head -n1)
            - git push --set-upstream github master
