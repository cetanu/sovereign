image: python:3.7

options:
  docker: true

pipelines:
  default:
    - step: &install
        name: Install deps & build containers
        caches: &caches
          - pip
          - docker
        script:
          - pip install --no-cache-dir --upgrade pip
          - pip install --no-cache-dir --upgrade -r requirements-dev.txt
          - make build
    - parallel: &test
        - step:
            name: Run pylint
            caches: [pip]
            script:
              - pip install pylint
              - pip install --upgrade -r requirements.txt
              - make lint
        - step:
            name: Unit tests
            caches: [pip]
            script:
              - wget https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 -o cc-test-reporter
              - ./cc-test-reporter before-build
              - pip install docker-compose
              - make unit
            after-script:
              - ./cc-test-reporter format-coverage --input-type coverage.py .coverage
              - ./cc-test-reporter upload-coverage
        - step:
            name: Acceptance tests
            caches: *caches
            script:
              - pip install docker-compose
              - make run-daemon acceptance
            after-script:
              - docker logs controlplane
  branches:
    master:
      - step: *install
      - parallel: *test
      - step:
          name: Release to PyPI
          script:
            - pip install docker-compose twine
            - make release
      - step:
          name: Documentation update
          caches: *caches
          script:
            - pip install docker-compose
            - git clone git@bitbucket.org:vsyrakis/vsyrakis.bitbucket.io.git
            - make html
            - rm -rf vsyrakis.bitbucket.io/sovereign/docs/*
            - cp -rvf src/sovereign/docs vsyrakis.bitbucket.io/sovereign
            - cd vsyrakis.bitbucket.io
            - git add -A
            - git status
            - git config user.email "vsyrakis@atlassian.com"
            - git config user.name "Vasilios Syrakis"
            - git commit -m "Documentation automatically updated by Sovereign pipeline"
            - git push
      - step:
          name: Mirror to github
          script:
            - git remote add --mirror=push github git@github.com:cetanu/sovereign.git
            - git push github
